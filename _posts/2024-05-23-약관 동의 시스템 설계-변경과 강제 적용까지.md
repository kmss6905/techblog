# 토이 프로젝트의 약관 동의 시스템 설계

토이 프로젝트 설계 시 약관 및 개인정보 처리방침 같은 부분을 간과하기 쉽다. 하지만 사용자의 데이터를 다루는 서비스라면 반드시 고려해야 할 필수 요소이다.

일반적으로 회원가입 시점에 사용자 데이터를 수집하고 관리하기 위해 약관 동의를 받는다. 필수 약관에 동의하지 않으면 회원가입을 막고, 광고성 정보 수신 동의와 같은 항목은 선택사항으로 제공하기도 한다.

### 기본 데이터베이스 스키마 설계

사용자의 약관 동의 여부를 저장하기 위해서는 각 약관의 유형(필수, 선택)과 실제 동의 여부를 관리해야 한다. 이를 위해 `Terms`와 `UserTerms` 두 개의 테이블로 스키마를 설계할 수 있다.

1.  **Terms**: 약관의 내용과 속성을 저장하는 테이블
2.  **UserTerms**: 사용자가 각 약관에 동의했는지 여부를 저장하는 테이블

<!-- end list -->

```sql
-- 약관 정보를 저장하는 테이블
CREATE TABLE Terms (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,                 -- 약관 이름 (예: 서비스 이용약관, 개인정보 처리방침)
    content TEXT,                               -- 약관 내용
    type ENUM('mandatory', 'optional') NOT NULL, -- 약관 타입 (mandatory: 필수, optional: 선택)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자의 약관 동의 정보를 저장하는 테이블
CREATE TABLE UserTerms (
    user_id INT NOT NULL,
    term_id INT NOT NULL,
    agreed TINYINT(1) NOT NULL,                 -- 동의 여부 (1: 동의, 0: 비동의)
    agreed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, term_id),             -- 복합 기본 키로 중복 동의 방지
    FOREIGN KEY (user_id) REFERENCES Users(id),
    FOREIGN KEY (term_id) REFERENCES Terms(id)
);
```

> `UserTerms` 테이블은 `user_id`와 `term_id`를 복합 기본 키(Composite Primary Key)로 설정하여, 한 명의 사용자가 동일한 약관에 대해 여러 번 동의 정보를 남기는 것을 방지한다.

### 약관이 변경된다면?

기업은 기존에 동의받은 약관 내용이 변경되면 사용자에게 이를 고지할 의무가 있다.

만약 `Terms` 테이블의 1번 약관 내용이 변경되었다면, `UserTerms` 테이블을 조회하여 1번 약관에 동의했던 모든 사용자에게 개정 안내 메일을 발송할 수 있다.

![](https://velog.velcdn.com/images/kmss6905/post/e60acbb4-1724-4c28-b8ad-c4cb06339027/image.png)

하지만 약관이 개정되었을 때, **사용자가 변경된 약관에 반드시 재동의해야만 서비스를 계속 이용할 수 있도록** 만들어야 하는 경우는 어떻게 처리해야 하는가?

### 해결책 1: 약관에 '버전(Version)' 도입

이 문제를 해결하기 위해 약관에 버전을 관리하는 개념을 도입할 수 있다.

  - **Minor Version (e.g., 1.0 -\> 1.1)**: 내용의 일부 수정 등 사용자에게 고지만 하면 되고, 명시적인 재동의가 필요 없는 경우에 사용.
  - **Major Version (e.g., 1.0 -\> 2.0)**: 개인정보 수집 항목 변경 등 매우 중요한 내용이 개정되어 사용자에게 **반드시 명시적인 재동의**를 받아야 하는 경우에 사용.

버전 관리를 위해 `TermVersions`라는 별도의 테이블을 추가하고, `Terms`와 1:N 관계를 맺도록 설계한다.

```sql
-- 약관의 버전별 내용을 관리하는 테이블
CREATE TABLE TermVersions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    term_id INT NOT NULL,
    version VARCHAR(20) NOT NULL, -- "1.0", "2.0" 등 버전 정보
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (term_id) REFERENCES Terms(id)
);
```

이제 `UserTerms` 테이블은 `term_id` 대신 `term_version_id`를 참조하여 어떤 사용자가 **어떤 약관의 몇 번째 버전**에 동의했는지 정확하게 기록할 수 있다.

### 해결책 2: 변경된 약관 동의 강제

새로운 필수 약관이 추가되거나 기존 약관이 중요하게 변경되어 재동의가 필요한 경우, 동의하지 않은 사용자의 서비스 이용을 제한해야 한다. 이를 강제하는 방법은 여러 가지가 있다.

-----

#### 방법 1: 모든 API 요청 시 동의 여부 확인

API가 호출될 때마다 해당 사용자가 최신 필수 약관에 모두 동의했는지 DB에서 확인하는 방식이다.

```java
public void someServiceLogic() {
    // 1. 최신 필수 약관 동의 여부 확인 로직
    if (!hasAgreedToLatestTerms(user)) {
        throw new AccessDeniedException("최신 약관에 동의해야 합니다.");
    }

    // 2. 원래 서비스 로직 수행
    // ...
}
```

  **장점**: **구현이 직관적이고 간단하다.** : 필요한 API 로직에 확인 코드를 추가하기만 하면 된다.
  **단점**
      - **불필요한 DB 접근 증가**: 약관 변경은 자주 일어나지 않는데, 모든 요청마다 DB를 조회하는 것은 비효율적이다.
      - **높은 결합도**: 비즈니스 로직과 약관 동의 확인이라는 서로 다른 관심사가 하나의 메서드에 섞여 유지보수가 어려워진다. (AOP로 분리 가능)

-----

#### 방법 2: 로그인 직후 별도의 '동의 확인 API' 호출

로그인 성공 직후, 클라이언트가 최신 약관 동의 여부를 확인하는 API를 호출하는 방식이다. 만약 동의가 필요한 약관이 있다면, 서버는 적절한 응답을 보내고 클라이언트는 동의 페이지로 유도한다.

**장점** : 각 API마다 동의 여부를 확인하지 않아도 되므로 서버의 부담이 줄어든다.
**단점** : **클라이언트에 대한 의존성**: 클라이언트가 '동의 확인 API' 를 반드시 호출해야만 로직이 성립한다. 악의적인 사용자가 이 API 호출을 건너뛰고 다른 API를 직접 호출하는 경우를 막을 수 없다. **서버는 클라이언트를 신뢰해서는 안 된다.**

-----

#### 방법 3: JWT Claim에 최신 약관 동의 버전 정보 저장 (방법 2 보완)

이 방법은 2번의 단점을 보완한다. 로그인 시 JWT(JSON Web Token)를 발급할 때, Claim에 **사용자가 동의한 최신 필수 약관의 버전**을 포함시키는 것이다.

```json
{
  "sub": "user123",
  "name": "John Doe",
  "iat": 1516239022,
  "latest_mandatory_terms_version": "2.0"
}
```

서버는 API 요청이 들어올 때마다 토큰의 `latest_mandatory_terms_version` 클레임 값을 현재 시스템이 요구하는 최신 필수 약관 버전과 비교한다.

**장점** : 토큰에 약관 버전 정보가 있으므로, **추가적인 DB 조회 없이** 동의 여부를 검증할 수 있어 매우 효율적이다.
**단점** : 사용자가 새로운 약관에 동의한 후에는, 변경된 버전 정보가 담긴 **새로운 토큰을 재발급**해주어야 한다.